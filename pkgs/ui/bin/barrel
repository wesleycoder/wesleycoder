#!/usr/bin/env bash

TMP_EXPORTS="$(mktemp)"

if [ $# -gt 1 ]; then
  TARGET_DIR="$1"
  BARREL_FILE="$2"
  BARREL_DIR=$(dirname "$BARREL_FILE")
  BARREL_DIR="${BARREL_DIR#./}"
else
  echo "Usage: $(basename "$0") <TARGET_DIR> <BARREL_FILE>" >&2
  exit 1
fi

trap 'rm -f "$TMP_EXPORTS"' EXIT

HEADER="/**
 ⚠️ This file is auto-generated by \`./$(basename "$0")\`.
 ⚠️ Do not edit directly.
*/"

echo "Updating $BARREL_FILE..."

find "$TARGET_DIR" \
  -maxdepth 4 \
  -type f \( -name "*.ts" -o -name "*.tsx" \) \
  ! -name "*test*" \
  -print |
  sort |
  while IFS= read -r entry; do
    entry="${entry#./}"
    entry="${entry#$BARREL_DIR/}"
    printf 'export * from "./%s";\n' "$entry" >>"$TMP_EXPORTS"
    ((COUNT++))
  done

printf '%s\n\n' "$HEADER" >"$BARREL_FILE"

if [ -s "$TMP_EXPORTS" ]; then
  cat "$TMP_EXPORTS" >>"$BARREL_FILE"
fi

echo "✅ Exported $COUNT file(s) to $BARREL_FILE"
